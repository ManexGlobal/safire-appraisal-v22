<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Safire Appraisal V22</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0b0c10;
        color: #f5f5f5;
      }

      body {
        margin: 0;
        padding: 1.5rem;
        background: radial-gradient(circle at top, #1f2833 0, #0b0c10 55%);
      }

      h1 {
        margin: 0 0 0.25rem 0;
        font-size: 1.6rem;
      }

      .sub {
        color: #c5c6c7;
        font-size: 0.85rem;
        margin-bottom: 1rem;
      }

      .card {
        background: rgba(15, 20, 30, 0.95);
        border-radius: 16px;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(10px);
      }

      .row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .row + .row {
        margin-top: 0.75rem;
      }

      .pill-toggle {
        display: inline-flex;
        padding: 3px;
        background: #0b0c10;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .pill-toggle button {
        border: none;
        background: transparent;
        color: #c5c6c7;
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
      }

      .pill-toggle button.active {
        background: #45a29e;
        color: #0b0c10;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .badge-good {
        border-color: #45a29e;
      }
      .badge-good .badge-dot {
        background: #45a29e;
      }

      .badge-warning {
        border-color: #ffb347;
      }
      .badge-warning .badge-dot {
        background: #ffb347;
      }

      .badge-danger {
        border-color: #ff6b6b;
      }
      .badge-danger .badge-dot {
        background: #ff6b6b;
      }

      .table-wrapper {
        margin-top: 1rem;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        min-width: 900px;
      }

      th,
      td {
        padding: 0.4rem 0.35rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }

      th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #c5c6c7;
        background: rgba(10, 15, 25, 0.9);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tr:nth-child(even) td {
        background: rgba(255, 255, 255, 0.01);
      }

      input,
      select {
        background: rgba(10, 15, 25, 0.9);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 0.25rem 0.35rem;
        color: #f5f5f5;
        font-size: 0.8rem;
        width: 100%;
        box-sizing: border-box;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #45a29e;
        box-shadow: 0 0 0 1px rgba(69, 162, 158, 0.4);
      }

      input[type="number"] {
        text-align: right;
      }

      .btn {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        padding: 0.35rem 0.9rem;
        font-size: 0.8rem;
        color: #f5f5f5;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .btn-primary {
        background: #45a29e;
        border-color: #66fcf1;
        color: #0b0c10;
      }

      .btn-ghost {
        background: transparent;
      }

      .btn-danger {
        border-color: #ff6b6b;
        color: #ff6b6b;
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: default;
      }

      .summary {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.85rem;
      }

      .summary-item {
        padding: 0.5rem 0.75rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .summary-label {
        color: #c5c6c7;
        margin-right: 0.35rem;
      }

      .summary-value {
        font-weight: 600;
      }

      .hint {
        font-size: 0.7rem;
        color: #c5c6c7;
        opacity: 0.8;
      }

      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .chip {
        font-size: 0.7rem;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid transparent;
      }

      .chip.highlight {
        border-color: #45a29e;
      }

      .tag-estimado {
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 999px;
        border: 1px dashed #ffb347;
        color: #ffb347;
        margin-left: 0.25rem;
      }

      .ai-panel textarea {
        width: 100%;
        min-height: 80px;
        resize: vertical;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        padding: 0.35rem 0.45rem;
        background: rgba(10, 15, 25, 0.9);
        color: #f5f5f5;
        font-size: 0.8rem;
        box-sizing: border-box;
      }

      .ai-panel {
        margin-top: 0.75rem;
        padding: 0.75rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed rgba(255, 255, 255, 0.12);
      }

      /* Modal simple para cÃ¡lculo por dimensiones */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
      }

      .modal {
        background: #0b0c10;
        border-radius: 16px;
        padding: 1rem 1.25rem;
        max-width: 360px;
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      }

      .modal h2 {
        font-size: 1rem;
        margin-top: 0;
      }

      .modal .row {
        margin-top: 0.5rem;
      }

      .modal-actions {
        margin-top: 0.75rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      @media (max-width: 768px) {
        body {
          padding: 0.75rem;
        }

        .card {
          padding: 0.9rem;
        }

        table {
          min-width: 750px;
        }

        h1 {
          font-size: 1.3rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <!-- Cabecera -->
      <div
        class="row"
        style="justify-content: space-between; margin-bottom: 0.5rem;"
      >
        <div>
          <h1>Safire Appraisal V22</h1>
          <div class="sub">
            Comparador de costes vs precio de venta para joyerÃ­a / relojerÃ­a.
          </div>
          <div class="row">
            <div class="pill-toggle" id="modeToggle">
              <button data-mode="basic" class="active">Modo bÃ¡sico</button>
              <button data-mode="advanced">Modo avanzado</button>
            </div>
            <span class="hint">
              BÃ¡sico: rÃ¡pido y guiado. Avanzado: aÃ±ade mano de obra y unidades
              tÃ©cnicas.
            </span>
          </div>
        </div>
        <div class="chip-group">
          <div class="chip highlight">EUR / g Â· ct Â· dwt Â· ozt Â· ud</div>
          <div class="chip">Peso manual / estimado</div>
          <div class="chip">Detector de sobreprecio</div>
        </div>
      </div>

      <!-- Ficha de pieza (marca / tipo / modelo) -->
      <div class="row" id="pieceMetaRow">
        <label class="hint" style="flex: 1 1 160px;">
          Tipo de pieza:
          <select id="pieceTypeSelect">
            <option value="">â€” Seleccionar â€”</option>
            <option value="anillo">Anillo</option>
            <option value="alianza">Alianza</option>
            <option value="pendientes">Pendientes</option>
            <option value="collar">Collar</option>
            <option value="cadena">Cadena</option>
            <option value="pulsera">Pulsera</option>
            <option value="reloj">Reloj</option>
            <option value="otro">Otro</option>
          </select>
        </label>
        <label class="hint" style="flex: 1 1 160px;">
          Marca:
          <input id="brandInput" type="text" placeholder="Cartier, Rolex..." />
        </label>
        <label class="hint" style="flex: 1 1 160px;">
          Modelo / referencia:
          <input id="modelInput" type="text" placeholder="Ref. interna..." />
        </label>
      </div>

      <!-- Barra de opciones globales -->
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <label class="hint">
            Divisa:&nbsp;
            <select id="currencySelect" title="Solo afecta al formato">
              <option value="EUR">EUR â‚¬</option>
              <option value="USD">USD $</option>
            </select>
          </label>
          <label class="hint">
            Plantilla rÃ¡pida:&nbsp;
            <select id="templateSelect">
              <option value="">â€” VacÃ­a â€”</option>
              <option value="solitario_ligero">
                Solitario ligero (3.5 g oro + 0.20 ct)
              </option>
              <option value="solitario_potente">
                Solitario potente (4.5 g oro + 0.35 ct)
              </option>
              <option value="alianza_fina">Alianza fina (3.0 g)</option>
              <option value="alianza_ancha">Alianza ancha (6.0 g)</option>
              <option value="cadena_fina">Cadena fina 45 cm (6.0 g)</option>
              <option value="cadena_gruesa">
                Cadena gruesa 60 cm (15.0 g)
              </option>
              <option value="reloj_acero">Reloj acero + zafiro</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button
            class="btn btn-ghost"
            id="dimensionsBtn"
            title="Calcular peso aproximado a partir de dimensiones fÃ­sicas"
          >
            âš™ Calc. peso por dimensiones
          </button>
          <button
            class="btn btn-ghost"
            id="saveSnapshotBtn"
            title="Guardar esta comparaciÃ³n en el historial"
          >
            ðŸ’¾ Guardar comparaciÃ³n
          </button>
          <label class="hint">
            Historial:
            <select id="historySelect">
              <option value="">â€” Ninguna â€”</option>
            </select>
          </label>
          <button
            class="btn btn-ghost"
            id="exportCsvBtn"
            title="Exportar a CSV"
          >
            â¬‡ CSV
          </button>
        </div>
      </div>

      <!-- SecciÃ³n mano de obra (solo avanzado) -->
      <div
        id="laborSection"
        class="row"
        style="margin-top: 0.75rem; display: none;"
      >
        <span class="hint" style="flex-basis: 100%;">
          Mano de obra (solo avanzado): aÃ±ade el trabajo (engastado, ensamblado,
          acabados...) como una lÃ­nea mÃ¡s.
        </span>
        <label class="hint" style="flex: 1 1 120px;">
          Dificultad:
          <select id="laborDifficultySelect">
            <option value="sencilla">Sencilla</option>
            <option value="media" selected>Media</option>
            <option value="compleja">Compleja</option>
          </select>
        </label>
        <label class="hint" style="flex: 1 1 120px;">
          Tarifa mano de obra (â‚¬/h):
          <input
            id="laborRateInput"
            type="number"
            step="1"
            min="0"
            placeholder="50"
          />
        </label>
        <label class="hint" style="flex: 1 1 120px;">
          Horas estimadas:
          <input
            id="laborHoursInput"
            type="number"
            step="0.1"
            min="0"
            placeholder="1.0"
          />
        </label>
        <button class="btn btn-ghost" id="addLaborBtn">
          + AÃ±adir lÃ­nea de mano de obra
        </button>
      </div>

      <!-- Tabla principal -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Material</th>
              <th>Tipo</th>
              <th>Unidad</th>
              <th>Peso</th>
              <th>Coste unit.</th>
              <th>Coste total</th>
              <th>Origen peso</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <!-- Acciones y diagnÃ³stico -->
      <div
        class="row"
        style="margin-top: 0.75rem; justify-content: space-between;"
      >
        <div class="row">
          <button class="btn btn-primary" id="addLineBtn">
            + AÃ±adir material
          </button>
          <button class="btn btn-ghost" id="resetBtn" title="Vaciar todo">
            Reiniciar
          </button>
        </div>
        <div class="badge badge-good" id="diagnosticBadge">
          <span class="badge-dot"></span>
          <span id="diagnosticText">Sin datos suficientes</span>
        </div>
      </div>

      <!-- Resumen -->
      <div class="summary" id="summaryBar"></div>

      <div style="margin-top: 0.75rem;">
        <span class="hint">
          * El margen % se calcula vs coste total (materiales + mano de obra).
          Cuanto mayor sea, mÃ¡s "inflado" estÃ¡ el precio frente al valor
          material.
        </span>
      </div>
    </div>

    <!-- Modal para cÃ¡lculo por dimensiones -->
    <div id="dimensionsModal" class="modal-backdrop" style="display: none;">
      <div class="modal">
        <h2>Calcular peso por dimensiones</h2>
        <p class="hint">
          Volumen (largo Ã— ancho Ã— alto en cm) y densidad del material o
          estÃ¡ndar 2,7 g/cmÂ³.
        </p>
        <div class="row">
          <label class="hint" style="flex: 1;">
            LÃ­nea:
            <select id="dimLineSelect"></select>
          </label>
        </div>
        <div class="row">
          <label class="hint" style="flex: 1;">
            Largo (cm)
            <input id="dimLargo" type="number" step="0.01" min="0" />
          </label>
          <label class="hint" style="flex: 1;">
            Ancho (cm)
            <input id="dimAncho" type="number" step="0.01" min="0" />
          </label>
          <label class="hint" style="flex: 1;">
            Alto (cm)
            <input id="dimAlto" type="number" step="0.01" min="0" />
          </label>
        </div>
        <div class="row">
          <label class="hint" style="flex: 1;">
            Densidad:
            <select id="dimDensityMode">
              <option value="material">
                Usar densidad del material (si existe)
              </option>
              <option value="std">EstÃ¡ndar 2,7 g/cmÂ³</option>
            </select>
          </label>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" id="dimCancelBtn">Cancelar</button>
          <button class="btn btn-primary" id="dimApplyBtn">
            Aplicar peso estimado
          </button>
        </div>
      </div>
    </div>

    <script>
      // ==============================
      // TABLA MAESTRA DE MATERIALES
      // ==============================
      const MATERIAL_MASTER = [
        // Metales
        { nombre: "Oro 24k", tipo: "metal", unidad: "â‚¬/g", densidad: 19.3 },
        { nombre: "Oro 18k", tipo: "metal", unidad: "â‚¬/g", densidad: 15.6 },
        { nombre: "Oro 14k", tipo: "metal", unidad: "â‚¬/g", densidad: 13.1 },
        { nombre: "Oro 9k", tipo: "metal", unidad: "â‚¬/g", densidad: 11.0 },
        { nombre: "Plata 925", tipo: "metal", unidad: "â‚¬/g", densidad: 10.5 },
        { nombre: "Platino", tipo: "metal", unidad: "â‚¬/g", densidad: 21.45 },
        { nombre: "Acero 316L", tipo: "metal", unidad: "â‚¬/g", densidad: 8.0 },
        { nombre: "Titanio", tipo: "metal", unidad: "â‚¬/g", densidad: 4.5 },
        { nombre: "Paladio", tipo: "metal", unidad: "â‚¬/g", densidad: 12.0 },
        // Piedras
        { nombre: "Diamante", tipo: "piedra", unidad: "â‚¬/ct", densidad: 3.52 },
        { nombre: "Zafiro", tipo: "piedra", unidad: "â‚¬/ct", densidad: 4.0 },
        { nombre: "RubÃ­", tipo: "piedra", unidad: "â‚¬/ct", densidad: 4.0 },
        { nombre: "Esmeralda", tipo: "piedra", unidad: "â‚¬/ct", densidad: 2.7 },
        { nombre: "Amatista", tipo: "piedra", unidad: "â‚¬/ct", densidad: 2.7 },
        { nombre: "Topacio", tipo: "piedra", unidad: "â‚¬/ct", densidad: 3.6 },
        { nombre: "Perla", tipo: "piedra", unidad: "â‚¬/ct", densidad: 2.7 },
        // Otros
        { nombre: "CerÃ¡mica", tipo: "otro", unidad: "â‚¬/ud", densidad: 2.4 },
        { nombre: "NÃ¡car", tipo: "otro", unidad: "â‚¬/ud", densidad: 2.7 },
        { nombre: "Cristal", tipo: "otro", unidad: "â‚¬/ud", densidad: 2.5 },
        { nombre: "Otro metal", tipo: "metal", unidad: "â‚¬/g", densidad: 7.8 },
        { nombre: "Otro mineral", tipo: "piedra", unidad: "â‚¬/ct", densidad: 3 },
        { nombre: "Otro material", tipo: "otro", unidad: "â‚¬/ud", densidad: 2.7 },
        // Mano de obra
        {
          nombre: "Mano de obra",
          tipo: "mano_obra",
          unidad: "â‚¬/ud",
          densidad: 0
        }
      ];

      const MATERIAL_PRESETS = MATERIAL_MASTER.map((m) => ({
        nombre: m.nombre,
        tipo: m.tipo,
        unidad: m.unidad
      }));

      const STD_DENSITY = 2.7; // g/cm3 genÃ©rica

      // ==============================
      // ESTADO GLOBAL
      // ==============================
      const state = {
        mode: "basic", // "basic" | "advanced"
        currency: "EUR",
        pieceType: "",
        brand: "",
        model: "",
        lines: [],
        nextId: 1,
        snapshots: [],
        salePriceTotal: "" // precio venta del producto
      };

      // Elementos DOM
      const linesBody = document.getElementById("linesBody");
      const addLineBtn = document.getElementById("addLineBtn");
      const resetBtn = document.getElementById("resetBtn");
      const summaryBar = document.getElementById("summaryBar");
      const diagnosticBadge = document.getElementById("diagnosticBadge");
      const diagnosticText = document.getElementById("diagnosticText");
      const modeToggle = document.getElementById("modeToggle");
      const currencySelect = document.getElementById("currencySelect");
      const templateSelect = document.getElementById("templateSelect");
      const saveSnapshotBtn = document.getElementById("saveSnapshotBtn");
      const historySelect = document.getElementById("historySelect");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const dimensionsBtn = document.getElementById("dimensionsBtn");
      const dimensionsModal = document.getElementById("dimensionsModal");
      const dimLineSelect = document.getElementById("dimLineSelect");
      const dimLargo = document.getElementById("dimLargo");
      const dimAncho = document.getElementById("dimAncho");
      const dimAlto = document.getElementById("dimAlto");
      const dimDensityMode = document.getElementById("dimDensityMode");
      const dimCancelBtn = document.getElementById("dimCancelBtn");
      const dimApplyBtn = document.getElementById("dimApplyBtn");
      const laborSection = document.getElementById("laborSection");
      const laborDifficultySelect = document.getElementById(
        "laborDifficultySelect"
      );
      const laborRateInput = document.getElementById("laborRateInput");
      const laborHoursInput = document.getElementById("laborHoursInput");
      const addLaborBtn = document.getElementById("addLaborBtn");
      const pieceTypeSelect = document.getElementById("pieceTypeSelect");
      const brandInput = document.getElementById("brandInput");
      const modelInput = document.getElementById("modelInput");

      // ==============================
      // UTILIDADES
      // ==============================
      const LS_CURRENT_KEY = "safire_v22_current";
      const LS_HISTORY_KEY = "safire_v22_history";

      function getMasterFor(nombre) {
        return MATERIAL_MASTER.find((m) => m.nombre === nombre);
      }

      function createEmptyLine(overrides = {}) {
        const defaultMat = MATERIAL_PRESETS[0];
        return {
          id: state.nextId++,
          material: defaultMat.nombre,
          tipo: defaultMat.tipo,
          unidad: defaultMat.unidad,
          peso: "",
          costeUnitario: "",
          costeTotal: 0,
          pesoEstimado: false,
          ...overrides
        };
      }

      function initStateFresh() {
        state.lines = [createEmptyLine()];
        state.salePriceTotal = "";
      }

      function formatCurrency(n) {
        if (isNaN(n)) {
          return "0 " + (state.currency === "EUR" ? "â‚¬" : "$");
        }
        return n.toLocaleString("es-ES", {
          style: "currency",
          currency: state.currency,
          maximumFractionDigits: 2
        });
      }

      function formatPct(n) {
        if (isNaN(n)) return "0 %";
        return (
          n.toLocaleString("es-ES", {
            maximumFractionDigits: 1
          }) + " %"
        );
      }

      // ==============================
      // CÃLCULOS
      // ==============================
      function recalcLine(line) {
        const peso = parseFloat(line.peso) || 0;
        const cu = parseFloat(line.costeUnitario) || 0;
        const costeTotal = peso * cu;
        line.costeTotal = costeTotal;
      }

      function recalcAll() {
        state.lines.forEach(recalcLine);
      }

      function getGlobalMetrics() {
        let totalCoste = 0;
        state.lines.forEach((l) => {
          totalCoste += l.costeTotal || 0;
        });
        const pv = parseFloat(state.salePriceTotal) || 0;
        const margen = pv - totalCoste;
        const margenPctCoste = totalCoste > 0 ? (margen / totalCoste) * 100 : 0;
        return { totalCoste, salePriceTotal: pv, margen, margenPctCoste };
      }

      // ==============================
      // LOCALSTORAGE - HISTORIAL
      // ==============================
      function saveCurrentToLocalStorage() {
        const payload = {
          mode: state.mode,
          currency: state.currency,
          pieceType: state.pieceType,
          brand: state.brand,
          model: state.model,
          lines: state.lines,
          nextId: state.nextId,
          salePriceTotal: state.salePriceTotal
        };
        try {
          localStorage.setItem(LS_CURRENT_KEY, JSON.stringify(payload));
        } catch (e) {}
      }

      function loadCurrentFromLocalStorage() {
        try {
          const raw = localStorage.getItem(LS_CURRENT_KEY);
          if (!raw) return false;
          const data = JSON.parse(raw);
          if (!data || !Array.isArray(data.lines)) return false;
          state.mode = data.mode || "basic";
          state.currency = data.currency || "EUR";
          state.pieceType = data.pieceType || "";
          state.brand = data.brand || "";
          state.model = data.model || "";
          state.lines = data.lines;
          state.nextId = data.nextId || state.lines.length + 1;
          state.salePriceTotal = data.salePriceTotal || "";
          return true;
        } catch (e) {
          return false;
        }
      }

      function saveSnapshotToHistory(name) {
        const snapshot = {
          id: Date.now(),
          name,
          createdAt: new Date().toISOString(),
          data: {
            mode: state.mode,
            currency: state.currency,
            pieceType: state.pieceType,
            brand: state.brand,
            model: state.model,
            lines: state.lines,
            nextId: state.nextId,
            salePriceTotal: state.salePriceTotal
          }
        };
        let history = [];
        try {
          const raw = localStorage.getItem(LS_HISTORY_KEY);
          if (raw) history = JSON.parse(raw) || [];
        } catch (e) {}
        history.unshift(snapshot);
        history = history.slice(0, 20);
        try {
          localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {}
        state.snapshots = history;
        refreshHistorySelect();
      }

      function loadHistoryFromLocalStorage() {
        try {
          const raw = localStorage.getItem(LS_HISTORY_KEY);
          if (!raw) {
            state.snapshots = [];
            return;
          }
          state.snapshots = JSON.parse(raw) || [];
        } catch (e) {
          state.snapshots = [];
        }
      }

      function refreshHistorySelect() {
        historySelect.innerHTML =
          '<option value="">â€” Ninguna â€”</option>';
        state.snapshots.forEach((snap) => {
          const opt = document.createElement("option");
          const date = new Date(snap.createdAt);
          const label =
            snap.name +
            " Â· " +
            date.toLocaleString("es-ES", {
              day: "2-digit",
              month: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          opt.value = snap.id;
          opt.textContent = label;
          historySelect.appendChild(opt);
        });
      }

      function applySnapshot(id) {
        const snap = state.snapshots.find(
          (s) => String(s.id) === String(id)
        );
        if (!snap) return;
        state.mode = snap.data.mode || "basic";
        state.currency = snap.data.currency || "EUR";
        state.pieceType = snap.data.pieceType || "";
        state.brand = snap.data.brand || "";
        state.model = snap.data.model || "";
        state.lines = snap.data.lines || [];
        state.nextId = snap.data.nextId || state.lines.length + 1;
        state.salePriceTotal = snap.data.salePriceTotal || "";

        currencySelect.value = state.currency;
        pieceTypeSelect.value = state.pieceType;
        brandInput.value = state.brand;
        modelInput.value = state.model;

        modeToggle.querySelectorAll("button").forEach((btn) => {
          const m = btn.getAttribute("data-mode");
          btn.classList.toggle("active", m === state.mode);
        });
        laborSection.style.display =
          state.mode === "advanced" ? "flex" : "none";
        render();
      }

      // ==============================
      // RENDER
      // ==============================
      function render() {
        recalcAll();
        renderLines();
        renderSummary();
        updateDiagnostic();
        saveCurrentToLocalStorage();
      }

      function softUpdateAfterInput() {
        recalcAll();
        renderSummary();
        updateDiagnostic();
        saveCurrentToLocalStorage();
      }

      function renderLines() {
        linesBody.innerHTML = "";

        state.lines.forEach((line, idx) => {
          const tr = document.createElement("tr");

          // Material
          const tdMat = document.createElement("td");
          const selMat = document.createElement("select");
          MATERIAL_PRESETS.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.nombre;
            opt.textContent = p.nombre;
            selMat.appendChild(opt);
          });
          selMat.value = line.material;
          selMat.title = "Material lÃ­nea " + (idx + 1);
          selMat.addEventListener("change", (e) => {
            const preset = getMasterFor(e.target.value);
            line.material = e.target.value;
            if (preset) {
              line.tipo = preset.tipo;
              line.unidad = preset.unidad;
            }
            recalcLine(line);
            render();
          });
          tdMat.appendChild(selMat);
          tr.appendChild(tdMat);

          // Tipo
          const tdTipo = document.createElement("td");
          const selTipo = document.createElement("select");
          const tipoOptions = ["metal", "piedra", "otro", "mano_obra"];
          tipoOptions.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent =
              t === "metal"
                ? "Metal"
                : t === "piedra"
                ? "Piedra"
                : t === "mano_obra"
                ? "Mano de obra"
                : "Otro";
            selTipo.appendChild(opt);
          });
          selTipo.value = line.tipo;
          const master = getMasterFor(line.material);
          if (master) {
            selTipo.disabled = true;
          } else {
            selTipo.disabled = false;
          }
          selTipo.addEventListener("change", (e) => {
            if (getMasterFor(line.material)) return;
            line.tipo = e.target.value;
            if (line.tipo === "metal" && line.unidad === "â‚¬/ct") {
              line.unidad = "â‚¬/g";
            } else if (line.tipo === "piedra" && line.unidad === "â‚¬/g") {
              line.unidad = "â‚¬/ct";
            } else if (line.tipo === "mano_obra") {
              line.unidad = "â‚¬/ud";
              if (!line.peso) line.peso = 1;
            }
            recalcLine(line);
            render();
          });
          tdTipo.appendChild(selTipo);
          tr.appendChild(tdTipo);

          // Unidad
          const tdUnidad = document.createElement("td");
          const selUnidad = document.createElement("select");
          const unitsBasic = ["â‚¬/g", "â‚¬/ct", "â‚¬/ud"];
          const unitsAdvanced = ["â‚¬/g", "â‚¬/ct", "â‚¬/dwt", "â‚¬/ozt", "â‚¬/ud"];
          const units =
            state.mode === "basic" ? unitsBasic : unitsAdvanced;
          units.forEach((u) => {
            const opt = document.createElement("option");
            opt.value = u;
            opt.textContent = u;
            selUnidad.appendChild(opt);
          });
          if (!units.includes(line.unidad)) {
            line.unidad = units[0];
          }
          selUnidad.value = line.unidad;
          selUnidad.addEventListener("change", (e) => {
            line.unidad = e.target.value;
            recalcLine(line);
            render();
          });
          tdUnidad.appendChild(selUnidad);
          tr.appendChild(tdUnidad);

          // Peso
          const tdPeso = document.createElement("td");
          const inpPeso = document.createElement("input");
          inpPeso.type = "number";
          inpPeso.step = "0.001";
          inpPeso.min = "0";
          inpPeso.placeholder = "0.000";
          inpPeso.value = line.peso;
          inpPeso.title =
            "Peso en la unidad indicada. Si se rellena desde dimensiones, se marcarÃ¡ como estimado.";
          inpPeso.addEventListener("input", (e) => {
            line.peso = e.target.value;
            line.pesoEstimado = false;
            softUpdateAfterInput();
          });
          tdPeso.appendChild(inpPeso);
          if (line.pesoEstimado) {
            const tag = document.createElement("span");
            tag.className = "tag-estimado";
            tag.textContent = "Est.";
            tdPeso.appendChild(tag);
          }
          tr.appendChild(tdPeso);

          // Coste unitario
          const tdCu = document.createElement("td");
          const inpCu = document.createElement("input");
          inpCu.type = "number";
          inpCu.step = "0.01";
          inpCu.min = "0";
          inpCu.placeholder = "0.00";
          inpCu.value = line.costeUnitario;
          inpCu.addEventListener("input", (e) => {
            line.costeUnitario = e.target.value;
            softUpdateAfterInput();
          });
          tdCu.appendChild(inpCu);
          tr.appendChild(tdCu);

          // Coste total
          const tdCt = document.createElement("td");
          tdCt.textContent = formatCurrency(line.costeTotal);
          tr.appendChild(tdCt);

          // Origen peso
          const tdOrigen = document.createElement("td");
          if (state.mode === "basic") {
            tdOrigen.textContent = line.pesoEstimado ? "Estimado" : "Manual";
          } else {
            const selOrigen = document.createElement("select");
            [
              { value: "manual", label: "Manual" },
              { value: "estimado", label: "Estimado" }
            ].forEach((o) => {
              const opt = document.createElement("option");
              opt.value = o.value;
              opt.textContent = o.label;
              selOrigen.appendChild(opt);
            });
            selOrigen.value = line.pesoEstimado ? "estimado" : "manual";
            selOrigen.addEventListener("change", (e) => {
              line.pesoEstimado = e.target.value === "estimado";
              softUpdateAfterInput();
            });
            tdOrigen.appendChild(selOrigen);
          }
          tr.appendChild(tdOrigen);

          // Eliminar
          const tdDel = document.createElement("td");
          const btnDel = document.createElement("button");
          btnDel.className = "btn btn-ghost btn-danger";
          btnDel.textContent = "Ã—";
          btnDel.title = "Eliminar material";
          btnDel.addEventListener("click", () => {
            state.lines = state.lines.filter((l) => l.id !== line.id);
            if (state.lines.length === 0) {
              state.lines.push(createEmptyLine());
            }
            render();
          });
          tdDel.appendChild(btnDel);
          tr.appendChild(tdDel);

          linesBody.appendChild(tr);
        });
      }

      function renderSummary() {
        const { totalCoste, salePriceTotal, margen, margenPctCoste } =
          getGlobalMetrics();
        summaryBar.innerHTML = "";

        // Precio venta total (input)
        const pvItem = document.createElement("div");
        pvItem.className = "summary-item";
        const labelPv = document.createElement("span");
        labelPv.className = "summary-label";
        labelPv.textContent = "Precio venta total (producto)";
        const inputPv = document.createElement("input");
        inputPv.type = "number";
        inputPv.step = "0.01";
        inputPv.min = "0";
        inputPv.value =
          state.salePriceTotal !== "" ? state.salePriceTotal : "";
        inputPv.style.width = "110px";
        // Usamos change (no input) para que no se pierda el foco en cada tecla
        inputPv.addEventListener("change", (e) => {
          state.salePriceTotal = e.target.value;
          softUpdateAfterInput();
        });
        pvItem.appendChild(labelPv);
        pvItem.appendChild(inputPv);
        summaryBar.appendChild(pvItem);

        // Pieza (tipo / marca / modelo) como recordatorio
        const metaItem = document.createElement("div");
        metaItem.className = "summary-item";
        metaItem.innerHTML =
          '<span class="summary-label">Pieza:</span>' +
          '<span class="summary-value">' +
          (state.pieceType || "â€”") +
          (state.brand ? " Â· " + state.brand : "") +
          (state.model ? " Â· " + state.model : "") +
          "</span>";
        summaryBar.appendChild(metaItem);

        const blocks = [
          {
            label: "Coste total materiales + mano de obra",
            value: formatCurrency(totalCoste)
          },
          { label: "Margen total", value: formatCurrency(margen) },
          {
            label: "Margen total % vs coste",
            value: formatPct(margenPctCoste)
          }
        ];

        blocks.forEach((b) => {
          const div = document.createElement("div");
          div.className = "summary-item";
          div.innerHTML =
            '<span class="summary-label">' +
            b.label +
            '</span><span class="summary-value"> ' +
            b.value +
            "</span>";
          summaryBar.appendChild(div);
        });
      }

      // ==============================
      // DIAGNÃ“STICO DE SOBREPRECIO
      // ==============================
      function updateDiagnostic() {
        const { totalCoste, salePriceTotal, margen, margenPctCoste } =
          getGlobalMetrics();

        if (!totalCoste && !salePriceTotal) {
          diagnosticBadge.className = "badge badge-good";
          diagnosticText.textContent = "Sin datos suficientes";
          return;
        }

        if (margenPctCoste <= 20) {
          diagnosticBadge.className = "badge badge-good";
          diagnosticText.textContent =
            "Precio muy alineado con el valor material (poco inflado).";
        } else if (margenPctCoste <= 100) {
          diagnosticBadge.className = "badge badge-warning";
          diagnosticText.textContent =
            "Sobreprecio moderado frente al valor material.";
        } else {
          diagnosticBadge.className = "badge badge-danger";
          diagnosticText.textContent =
            "Precio muy por encima del valor material (posible sobreprecio).";
        }
      }

      // ==============================
      // EXPORT CSV
      // ==============================
      function exportToCsv() {
        const headers = [
          "Material",
          "Tipo",
          "Unidad",
          "Peso",
          "Coste unitario",
          "Coste total",
          "Origen peso"
        ];
        const rows = [headers];

        state.lines.forEach((l) => {
          rows.push([
            l.material,
            l.tipo,
            l.unidad,
            l.peso,
            l.costeUnitario,
            l.costeTotal,
            l.pesoEstimado ? "estimado" : "manual"
          ]);
        });

        const { totalCoste, salePriceTotal, margen, margenPctCoste } =
          getGlobalMetrics();

        rows.push([]);
        rows.push(["RESUMEN"]);
        rows.push(["Tipo de pieza", state.pieceType]);
        rows.push(["Marca", state.brand]);
        rows.push(["Modelo", state.model]);
        rows.push(["Coste total", totalCoste]);
        rows.push(["Precio venta total", salePriceTotal]);
        rows.push(["Margen total", margen]);
        rows.push(["Margen total % vs coste", margenPctCoste]);

        const csvContent = rows
          .map((r) => r.map((v) => `"${String(v ?? "")}"`).join(","))
          .join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "safire_appraisal_v22.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // ==============================
      // PLANTILLAS RÃPIDAS
      // ==============================
      function applyTemplate(name) {
        if (!name) return;
        if (!confirm("Esto reemplazarÃ¡ las lÃ­neas actuales. Â¿Continuar?")) {
          templateSelect.value = "";
          return;
        }
        state.lines = [];
        state.nextId = 1;

        if (name === "solitario_ligero") {
          state.pieceType = "anillo";
          pieceTypeSelect.value = "anillo";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 3.5,
              pesoEstimado: true
            })
          );
          state.lines.push(
            createEmptyLine({
              material: "Diamante",
              tipo: "piedra",
              unidad: "â‚¬/ct",
              peso: 0.2,
              pesoEstimado: true
            })
          );
        } else if (name === "solitario_potente") {
          state.pieceType = "anillo";
          pieceTypeSelect.value = "anillo";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 4.5,
              pesoEstimado: true
            })
          );
          state.lines.push(
            createEmptyLine({
              material: "Diamante",
              tipo: "piedra",
              unidad: "â‚¬/ct",
              peso: 0.35,
              pesoEstimado: true
            })
          );
        } else if (name === "alianza_fina") {
          state.pieceType = "alianza";
          pieceTypeSelect.value = "alianza";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 3.0,
              pesoEstimado: true
            })
          );
        } else if (name === "alianza_ancha") {
          state.pieceType = "alianza";
          pieceTypeSelect.value = "alianza";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 6.0,
              pesoEstimado: true
            })
          );
        } else if (name === "cadena_fina") {
          state.pieceType = "cadena";
          pieceTypeSelect.value = "cadena";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 6.0,
              pesoEstimado: true
            })
          );
        } else if (name === "cadena_gruesa") {
          state.pieceType = "cadena";
          pieceTypeSelect.value = "cadena";
          state.lines.push(
            createEmptyLine({
              material: "Oro 18k",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 15.0,
              pesoEstimado: true
            })
          );
        } else if (name === "reloj_acero") {
          state.pieceType = "reloj";
          pieceTypeSelect.value = "reloj";
          state.lines.push(
            createEmptyLine({
              material: "Acero 316L",
              tipo: "metal",
              unidad: "â‚¬/g",
              peso: 80.0,
              pesoEstimado: true
            })
          );
          state.lines.push(
            createEmptyLine({
              material: "Zafiro",
              tipo: "piedra",
              unidad: "â‚¬/ct",
              peso: 0.1,
              pesoEstimado: true
            })
          );
        }

        render();
        templateSelect.value = "";
      }

      // ==============================
      // CÃLCULO POR DIMENSIONES
      // ==============================
      function openDimensionsModal() {
        dimLineSelect.innerHTML = "";
        state.lines.forEach((l, idx) => {
          const opt = document.createElement("option");
          opt.value = l.id;
          opt.textContent = idx + 1 + " Â· " + l.material;
          dimLineSelect.appendChild(opt);
        });
        dimLargo.value = "";
        dimAncho.value = "";
        dimAlto.value = "";
        dimDensityMode.value = "material";
        dimensionsModal.style.display = "flex";
      }

      function closeDimensionsModal() {
        dimensionsModal.style.display = "none";
      }

      function applyDimensionsToLine() {
        const lineId = parseInt(dimLineSelect.value, 10);
        const largo = parseFloat(dimLargo.value) || 0;
        const ancho = parseFloat(dimAncho.value) || 0;
        const alto = parseFloat(dimAlto.value) || 0;
        if (!lineId || !largo || !ancho || !alto) {
          alert("Introduce largo, ancho y alto en cm.");
          return;
        }
        const line = state.lines.find((l) => l.id === lineId);
        if (!line) return;

        const volume = largo * ancho * alto; // cm3
        let density = STD_DENSITY;
        if (dimDensityMode.value === "material") {
          const master = getMasterFor(line.material);
          density = (master && master.densidad) || STD_DENSITY;
        }
        const weightGrams = volume * density;

        line.peso = weightGrams.toFixed(3);
        line.pesoEstimado = true;
        recalcLine(line);
        render();
        closeDimensionsModal();
      }

      // ==============================
      // EVENTOS GLOBALES
      // ==============================
      modeToggle.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.getAttribute("data-mode");
          if (mode === state.mode) return;
          state.mode = mode;

          modeToggle.querySelectorAll("button").forEach((b) => {
            b.classList.toggle(
              "active",
              b.getAttribute("data-mode") === state.mode
            );
          });

          laborSection.style.display =
            state.mode === "advanced" ? "flex" : "none";

          render();
        });
      });

      addLineBtn.addEventListener("click", () => {
        state.lines.push(createEmptyLine());
        render();
      });

      resetBtn.addEventListener("click", () => {
        if (!confirm("Â¿Seguro que quieres vaciar todo?")) return;
        state.nextId = 1;
        state.pieceType = "";
        state.brand = "";
        state.model = "";
        pieceTypeSelect.value = "";
        brandInput.value = "";
        modelInput.value = "";
        initStateFresh();
        render();
      });

      currencySelect.addEventListener("change", (e) => {
        state.currency = e.target.value;
        render();
      });

      templateSelect.addEventListener("change", (e) => {
        applyTemplate(e.target.value);
      });

      saveSnapshotBtn.addEventListener("click", () => {
        const name =
          prompt(
            "Nombre para esta comparaciÃ³n (ej: 'Solitario cliente X')"
          ) || "";
        if (!name.trim()) return;
        saveSnapshotToHistory(name.trim());
      });

      historySelect.addEventListener("change", (e) => {
        const id = e.target.value;
        if (!id) return;
        applySnapshot(id);
      });

      exportCsvBtn.addEventListener("click", exportToCsv);

      dimensionsBtn.addEventListener("click", openDimensionsModal);
      dimCancelBtn.addEventListener("click", closeDimensionsModal);
      dimApplyBtn.addEventListener("click", applyDimensionsToLine);

      dimensionsModal.addEventListener("click", (e) => {
        if (e.target === dimensionsModal) {
          closeDimensionsModal();
        }
      });

      addLaborBtn.addEventListener("click", () => {
        const difficulty = laborDifficultySelect.value;
        const rate = parseFloat(laborRateInput.value) || 0;
        const hours = parseFloat(laborHoursInput.value) || 0;
        if (!rate || !hours) {
          alert("Introduce una tarifa y unas horas mayores que 0.");
          return;
        }
        const cost = rate * hours;
        const labelDiff =
          difficulty === "sencilla"
            ? "sencilla"
            : difficulty === "compleja"
            ? "compleja"
            : "media";
        state.lines.push(
          createEmptyLine({
            material: `Mano de obra (${labelDiff})`,
            tipo: "mano_obra",
            unidad: "â‚¬/ud",
            peso: 1,
            costeUnitario: cost.toFixed(2),
            pesoEstimado: false
          })
        );
        laborRateInput.value = "";
        laborHoursInput.value = "";
        render();
      });

      pieceTypeSelect.addEventListener("change", (e) => {
        state.pieceType = e.target.value;
        softUpdateAfterInput();
      });

      brandInput.addEventListener("input", (e) => {
        state.brand = e.target.value;
        softUpdateAfterInput();
      });

      modelInput.addEventListener("input", (e) => {
        state.model = e.target.value;
        softUpdateAfterInput();
      });

      // ==============================
      // BOOTSTRAP
      // ==============================
      loadHistoryFromLocalStorage();
      refreshHistorySelect();

      const hasCurrent = loadCurrentFromLocalStorage();
      if (!hasCurrent) {
        initStateFresh();
      } else {
        currencySelect.value = state.currency;
        pieceTypeSelect.value = state.pieceType;
        brandInput.value = state.brand;
        modelInput.value = state.model;

        modeToggle.querySelectorAll("button").forEach((btn) => {
          const m = btn.getAttribute("data-mode");
          btn.classList.toggle("active", m === state.mode);
        });
      }

      laborSection.style.display =
        state.mode === "advanced" ? "flex" : "none";

      render();
    </script>
  </body>
</html>
